<!DOCTYPE html>
<html lang="en">
	<head>
		<title>WebGL shared uniforms</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #fff;
				font-family:Monospace;
				font-size:13px;
				margin: 0px;
				text-align:center;
				overflow: hidden;
			}
			#info{ position: absolute; width: 100%; padding: 5px; bottom:0;}
		</style>
	</head>
	<body>

		<div id="container"></div>
		<div id="info">
			<strong>Shared uniforms</strong><br />
		</div>

		<script src="../build/three.min.js"></script>
		<script src="js/controls/OrbitControls.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>

		<script>

		var container = document.getElementById( 'container' );

		var renderer, scene, camera, fov = 45;

		var controls;

		var clock;

		var shaderParams;

		var _eul = new THREE.Euler();

		var masterMaterial;

		function init() {

			clock = new THREE.Clock();

			renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			container.appendChild( renderer.domElement );

			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera( fov, window.innerWidth / window.innerHeight, 1, 1000 );
			camera.position.z = 100;
			camera.target = new THREE.Vector3();

			controls = new THREE.OrbitControls( camera, renderer.domElement );
			controls.minDistance = 50;
			controls.maxDistance = 200;
			

			window.addEventListener( 'resize', onWindowResize, false );




			/*****************************************
			 * shader
			 *****************************************/
			var vs = [

				'varying vec3 vVD;',
				'varying vec3 vNormal;',
				'void main(){',
					'vNormal = (modelMatrix * vec4( normal , 0.)).xyz;',
					'vec4 wp = modelMatrix * vec4( position , 1.);',
					'vVD = cameraPosition - wp.xyz;',
					'gl_Position = projectionMatrix * viewMatrix * modelMatrix * wp;',
				'}'

			].join('\n');

			var fs = [
				'varying vec3 vVD;',
				'varying vec3 vNormal;',

				'uniform vec3 uGlobalLight;',
				'uniform float uGloss;',
				'uniform float uSpec;',
				'uniform vec3 uColor;',

				'void main(){',
					'vec3 normal = normalize(vNormal);',
					'vec3 viewDir = normalize(vVD);',

					'float ndl = dot( normal , viewDir ) ;',

					'float ndh = dot( normal , normalize( viewDir + uGlobalLight ) );',

					'vec3 res = uColor * clamp( ndl , 0. , 1. ) + pow( clamp( ndh , 0. , 1. ) , uGloss ) * uSpec;',

					'gl_FragColor = vec4( res , 1. );',
				'}'

			].join('\n');

			/*********************
			 * material template
			 *********************/

			masterMaterial = new THREE.ShaderMaterial({
				
				uniforms:{
					
					//shared	
					uGloss: new THREE.Uniform( 'f' , 20 , true ),
					uSpec: new THREE.Uniform( 'f' , 1 , true ),
					uGlobalLight: new THREE.Uniform( 'v3' , new THREE.Vector3(1,1,1).normalize() , true ),

					//unique
					uColor: new THREE.Uniform( 'c' , new THREE.Color().setRGB(1,0,0) ) //default color
				},

				vertexShader: vs,
				fragmentShader: fs

			});


			/*********************
			 * some geometry
			 *********************/

			var sg = new THREE.SphereGeometry(2 , 32 , 32);

			
			//control mesh
			var mesh = new THREE.Mesh( sg , masterMaterial );

			scene.add( mesh );


			//meshclones

			var extents = 30;

			for ( var i = 0 ; i < 64 ; i ++ ) {

				mesh = i % 2 == 0 ? new THREE.Mesh( sg , masterMaterial.clone() ) : mesh.clone() ; //test material.clone and mesh.clone

				mesh.material.uniforms.uColor.value.setHex( ('0x'+Math.floor(Math.random()*16777215).toString(16)) ); 

				mesh.position.set(
					(Math.random() * 2 - 1) * extents,
					(Math.random() * 2 - 1) * extents,
					(Math.random() * 2 - 1) * extents
				);

				scene.add( mesh );

			}	



			var gui = new dat.GUI();

			//
			gui.add( masterMaterial.uniforms.uGloss, 'value', 1 , 200 ).name('uGloss');
			gui.add( masterMaterial.uniforms.uSpec, 'value', 0 , 1 ).name('uSpec');
			gui.open();

			onWindowResize();
			animate();

		}


		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function animate() {

			requestAnimationFrame( animate );

			_eul.y += clock.getDelta() * .21;

			masterMaterial.uniforms.uGlobalLight.value.set(1,1,1).normalize().applyEuler( _eul );

			renderer.render( scene, camera );

		}

		init();

		</script>

	</body>
</html>
