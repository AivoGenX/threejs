<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - cloth simulation</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
		<style>
			body {
				background-color: #cce0ff;
				color: #000;
			}
			a {
				color: #080;
			}
		</style>
	</head>

	<body>
		<div id="info">Simple Cloth Simulation<br/>
			Verlet integration with relaxed constraints<br/>
			<a onclick="toggleWind();">Wind</a> |
			<a onclick="togglePins();">Pins</a>
		</div>

		<script src="../build/three.js"></script>

		<script src="js/WebGL.js"></script>
		<script src="js/controls/OrbitControls.js"></script>
		<script src="js/libs/stats.min.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>

		<script src="js/Cloth.js"></script>

		<script>

			var camera, cloth;
			/* testing cloth simulation */

			var windFactor = 1;
			var windForce = new THREE.Vector3();

			var pinPositions = [
				[ 6 ],
				[ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ],
				[ 0 ],
				[], // cut the rope ;)
				[ 0, 10 ], // classic 2 pins
			];

			function togglePins() {

				cloth.pins = pinPositions[ ~~ ( Math.random() * pinPositions.length ) ];

			}

			function toggleWind() {

				windFactor = windFactor === 1 ? 0 : 1;

			}

			if ( WEBGL.isWebGLAvailable() === false ) {

				document.body.appendChild( WEBGL.getWebGLErrorMessage() );

			}

			init();

			function init() {

				var container = document.createElement( 'div' );
				document.body.appendChild( container );

				// scene

				var scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xcce0ff );
				scene.fog = new THREE.Fog( 0xcce0ff, 5, 100 );

				// camera

				camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 100 );
				camera.position.set( 2, 0.5, 4 );

				// lights

				scene.add( new THREE.HemisphereLight( 0xddeeff, 0x0f0e0d, 1 ) );

				var light = new THREE.DirectionalLight( 0xffffff, 1 );
  			light.position.set( -1, 1.5, 1 );
				light.castShadow = true;

				light.shadow.mapSize.width = 1024;
				light.shadow.mapSize.height = 1024;

				var d = 2;

				light.shadow.camera.left = - d;
				light.shadow.camera.right = d;
				light.shadow.camera.top = d;
				light.shadow.camera.bottom = - d;
				light.shadow.bias = -0.01;

				light.shadow.camera.far = 5;

				scene.add( light );

				// scene.add( new THREE.CameraHelper(light.shadow.camera) );

				var loader = new THREE.TextureLoader();
				var logo = loader.load( 'textures/logo.png' );
				logo.anisotropy = 16;
				logo.center.set( 0.5, 0.5 );
				logo.rotation = -Math.PI / 2;

				var clothMaterial = new THREE.MeshStandardMaterial( {
					map: logo,
					side: THREE.DoubleSide,
					metalness: 0,
					roughness: 0.9,
				} );


				cloth = new THREE.Cloth( 1, 1, 10, 10, clothMaterial );
				cloth.groundPos = - 0.5;
				cloth.scale.x = 0.5;
				scene.add( cloth );

				cloth.pins = pinPositions[ 1 ];

				cloth.castShadow = true;

				cloth.rotation.z = Math.PI / 2;
				cloth.receiveShadow = true;

				var groundMaterial = new THREE.MeshStandardMaterial( { color: 0x222222, metalness: 0 } );

				var mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 200, 200 ), groundMaterial );
				mesh.position.y = - 1;
				mesh.rotation.x = - Math.PI / 2;
				mesh.receiveShadow = true;
				scene.add( mesh );


				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.appendChild( renderer.domElement );

				renderer.toneMapping = THREE.ACESFilmicToneMapping;
				renderer.toneMappingExposure = 1.2;
				renderer.physicallyCorrectLights = true;
				renderer.gammaOutput = true;
				renderer.gammaFactor = 2.2;

				renderer.shadowMap.enabled = true;

				var controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.maxPolarAngle = Math.PI * 0.5;
				controls.minDistance = 2;
				controls.maxDistance = 20;
				controls.update();

				var stats = new Stats();
				container.appendChild( stats.dom );

				window.addEventListener( 'resize', onWindowResize, false );

				renderer.setAnimationLoop( () => {

					update();

					renderer.render( scene, camera );
					stats.update();

				} );

				addControls();

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function update() {

				var time = Date.now();

				var windStrength = ( Math.cos( time / 7000 ) * 2 + 4 ) * windFactor;

				cloth.force
					.set( Math.sin( time / 2000 ), Math.cos( time / 3000 ), Math.sin( time / 1000 ) )
					.normalize()
					.multiplyScalar( windStrength );

				cloth.simulate( time );

			}

			function addControls() {

				var gui = new dat.GUI();
				var settings = {
					'Wind Strength': 1,
				}

				gui.add( settings, 'Wind Strength' ).min( 0.0 ).max( 5.0 ).step( 0.01 ).onChange( function () {

					windFactor = settings[ 'Wind Strength' ];

				} );

			}


		</script>
	</body>
</html>
