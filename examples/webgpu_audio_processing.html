<html lang="en">
	<head>
		<title>three.js - WebGPU - Audio Processing</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>

		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> WebGPU - Audio Processing
			<br>Click on the screen to process the audio using WebGPU.
		</div>

		<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js",
					"three/addons/": "./jsm/",
					"three/nodes": "./jsm/nodes/Nodes.js"
				}
			}
		</script>

		<script type="module">

			import * as THREE from 'three';

			import {
				ShaderNode, compute,
				uniform, element, storage, instanceIndex,
				float, assign, add, sub, div, mul
			} from 'three/nodes';

			import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

			import WebGPU from 'three/addons/capabilities/WebGPU.js';
			import WebGPURenderer from 'three/addons/renderers/webgpu/WebGPURenderer.js';

			let renderer;
			let computeNode;
			let waveBuffer, sampleRate;
			let waveGPUBuffer;

			await init();

			async function playAudioBuffer() {

				renderer.compute( computeNode );

				const waveBuffer = await renderer.getArrayFromBuffer( waveGPUBuffer );

				//

				const audioOutputContext = new AudioContext( { sampleRate } );
				const audioOutputBuffer = audioOutputContext.createBuffer( 1, waveBuffer.length, sampleRate );

				audioOutputBuffer.copyToChannel( waveBuffer, 0 );

				const source = audioOutputContext.createBufferSource();
				source.connect( audioOutputContext.destination );
				source.buffer = audioOutputBuffer;
				source.start();

			}

			async function init() {

				if ( WebGPU.isAvailable() === false ) {

					document.body.appendChild( WebGPU.getErrorMessage() );

					throw new Error( 'No WebGPU support' );

				}

				document.onclick = () => {

					playAudioBuffer();

				};

				// audio buffer

				const buffer = await fetch( 'sounds/webgpu-audio-processing.mp3' ).then( res => res.arrayBuffer() );
				const audioContext = new AudioContext();

				const audioBuffer = await audioContext.decodeAudioData( buffer );

				waveBuffer = audioBuffer.getChannelData( 0 );

				// adding extra silence to delay and pitch
				waveBuffer = new Float32Array( [ ...waveBuffer, ...new Float32Array( 200000 ) ] );

				sampleRate = audioBuffer.sampleRate;


				// create webgpu buffers

				waveGPUBuffer = new THREE.InstancedBufferAttribute( waveBuffer, 1 );

				const waveStorageNode = storage( waveGPUBuffer, 'float', waveBuffer.length );


				// read-only buffer

				const waveNode = storage( new THREE.InstancedBufferAttribute( waveBuffer, 1 ), 'float', waveBuffer.length );


				// params

				const pitch = uniform( 1.5 );
				const delayVolume = uniform( .3 );
				const delayOffset = uniform( 4000 );


				// compute (shader-node)

				const computeShaderNode = new ShaderNode( ( inputs, builder ) => {

					// pitch

					const time = mul( float( instanceIndex ), pitch );

					let wave = element( waveNode, time );


					// delay

					for ( let i = 1; i < 7; i ++ ) {

						const waveOffset = element( waveNode, sub( time, mul( delayOffset, i ) ) );
						const waveOffsetVolume = mul( waveOffset, div( delayVolume, i ) );

						wave = add( wave, waveOffsetVolume );

					}

					//

					const waveStorageElementNode = element( waveStorageNode, instanceIndex );

					assign( waveStorageElementNode, wave ).build( builder );

				} );


				// compute

				computeNode = compute( computeShaderNode, waveBuffer.length );


				// gui

				const gui = new GUI();

				gui.add( pitch, 'value', .5, 2, 0.01 ).name( 'pitch' );
				gui.add( delayVolume, 'value', 0, 1, .01 ).name( 'delayVolume' );;
				gui.add( delayOffset, 'value', 500, 10000, 1 ).name( 'delayOffset' );;


				// renderer

				renderer = new WebGPURenderer();

				await renderer.init();

			}

		</script>
	</body>
</html>
