<!DOCTYPE html>
<html lang="en">
	<head>
		<title>threejs webgl - materials - ground projected environment mapping</title>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
		/>
		<link type="text/css" rel="stylesheet" href="main.css" />
	</head>
	<body>
		<div id="container"></div>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">threejs</a> -
			Ground projected environment mapping. Created by
			<a href="https://twitter.com/CantBeFaraz" target="_blank" rel="noopener"
				>Faraz Shaikh</a
			>.
		</div>

		<!-- Import maps polyfill -->
		<!-- Remove this when import maps will be widely supported -->
		<script
			async
			src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
		></script>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js"
				}
			}
		</script>

		<script type="module">
			import * as THREE from "three";

			import Stats from "./jsm/libs/stats.module.js";

			import { GUI } from "./jsm/libs/lil-gui.module.min.js";
			import { OrbitControls } from "./jsm/controls/OrbitControls.js";
			import { GroundProjectedEnv } from "./jsm/misc/GroundProjectedEnv.js";
			import { GLTFLoader } from "./jsm/loaders/GLTFLoader.js";

			const params = {
				height: 34,
				radius: 440,
			};

			let camera, scene, renderer, stats, env;

			init();
			animate();

			function init() {
				initScene();
				initMisc();

				document.body.appendChild(renderer.domElement);
				window.addEventListener("resize", onWindowResize);
			}

			function initScene() {
				camera = new THREE.PerspectiveCamera(
					45,
					window.innerWidth / window.innerHeight,
					1,
					1000
				);
				camera.position.set(-1, 0.5, 1).multiplyScalar(10);

				scene = new THREE.Scene();

				// Lights

				const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
				directionalLight.castShadow = true;
				directionalLight.position.set(10, 8, 10);
				scene.add(directionalLight);

				// Geometry

				const geometry = new THREE.PlaneGeometry(1, 1);
				const material = new THREE.ShadowMaterial({ opacity: 0.4 });

				const ground = new THREE.Mesh(geometry, material);
				ground.scale.setScalar(100);
				ground.rotation.x = -Math.PI / 2;
				ground.castShadow = false;
				ground.receiveShadow = true;
				scene.add(ground);

				const cubeLoader = new THREE.CubeTextureLoader();
				cubeLoader.setPath("textures/cube/lake/");

				const textureCube = cubeLoader.load([
					"px.png",
					"nx.png",
					"py.png",
					"ny.png",
					"pz.png",
					"nz.png",
				]);

				env = new GroundProjectedEnv(textureCube);
				env.scale.setScalar(100);
				scene.add(env);

				scene.background = textureCube;
				scene.environment = textureCube;

				const loader = new GLTFLoader().setPath(
					"models/gltf/DamagedHelmet/glTF/"
				);
				loader.load("DamagedHelmet.gltf", function (gltf) {
					gltf.scene.scale.setScalar(3);

					const box = new THREE.Box3().setFromObject(gltf.scene);
					gltf.scene.position.y = -box.min.y;

					gltf.scene.traverse((obj) => {
						if (obj.isMesh) {
							obj.castShadow = obj.recieveShadow = true;
						}
					});

					scene.add(gltf.scene);
				});
			}

			function initMisc() {
				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.shadowMap.enabled = true;
				renderer.shadowMap.type = THREE.BasicShadowMap;

				// Mouse control
				const controls = new OrbitControls(camera, renderer.domElement);
				controls.target.set(0, 2, 0);
				controls.update();

				stats = new Stats();
				document.body.appendChild(stats.dom);

				const gui = new GUI();
				gui.add(params, "height", 0, 400, 0.1);
				gui.add(params, "radius", 0, 2000, 0.1);
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize(window.innerWidth, window.innerHeight);
			}

			function animate() {
				requestAnimationFrame(animate);
				render();

				stats.update();
			}

			function renderScene() {
				renderer.render(scene, camera);
			}

			function render() {
				renderScene();

				env.radius = params.radius;
				env.height = params.height;
			}
		</script>
	</body>
</html>
