<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webvr - postprocessing</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #101010;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
			a {
				color: #f00;
			}
		</style>
	</head>
	<body>
		<script src="../build/three.js"></script>

		<script src="js/shaders/CopyShader.js"></script>
		<script src="js/shaders/DigitalGlitch.js"></script>
		<script src="js/shaders/LuminosityHighPassShader.js"></script>
		<script src="js/shaders/FilmShader.js"></script>
		<script src="js/shaders/FXAAShader.js"></script>

		<script src="js/postprocessing/EffectComposer.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script>
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/GlitchPass.js"></script>
		<script src="js/postprocessing/UnrealBloomPass.js"></script>

		<script src="js/vr/WebVR.js"></script>

		<script src="js/libs/stats.min.js"></script>
		<script src="js/libs/dat.gui.min.js"></script>

		<script>

			var container, stats;

			var camera, dummy, scene, renderer, composer;
			var group, light;

			// stats
			stats = new Stats();

			// renderer
			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.vr.enabled = true;

			// container
			container = document.createElement( 'div' );
			document.body.appendChild( container );

			container.appendChild( renderer.domElement );
			container.appendChild( WEBVR.createButton( renderer ) );
			container.appendChild( stats.dom );

			// scene
			scene = new THREE.Scene();
			scene.fog = new THREE.Fog( 0x000000, 1, 1000 );

			// camera
			camera = new THREE.PerspectiveCamera();

			dummy = new THREE.Camera();
			dummy.position.z = 400;
			dummy.add( camera );

			scene.add( dummy );

			// composer
			composer = new THREE.EffectComposer( renderer );
			composer.setSize( window.innerWidth, window.innerHeight );

			composer.addPass( new THREE.RenderPass( scene, camera ) );
			composer.addPass( new THREE.UnrealBloomPass( new THREE.Vector2( window.innerWidth, window.innerHeight ), 1.0, 0.7, 0.1 ) );
			composer.addPass( new THREE.ShaderPass( THREE.FilmShader ) );
			composer.addPass( new THREE.GlitchPass() );
			composer.addPass( new THREE.ShaderPass( THREE.FXAAShader ) );

			composer.passes[ composer.passes.length - 1 ].renderToScreen = true;

			// object
			group = new THREE.Group();
			scene.add( group );

			var geometry = new THREE.SphereGeometry( 1, 4, 4 );

			for ( var i = 0; i < 100; i ++ ) {

				var material = new THREE.MeshPhongMaterial( { color: 0xffffff * Math.random(), flatShading: true } );
				var mesh = new THREE.Mesh( geometry, material );
				mesh.position.set( Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5 ).normalize();
				mesh.position.multiplyScalar( Math.random() * 400 );
				mesh.rotation.set( Math.random() * 2, Math.random() * 2, Math.random() * 2 );
				mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 50;
				group.add( mesh );

			}

			scene.add( new THREE.AmbientLight( 0x222222 ) );

			// lights
			light = new THREE.DirectionalLight( 0xffffff );
			light.position.set( 1, 1, 1 );
			scene.add( light );

			window.addEventListener( 'resize', onWindowResize, false );
			window.addEventListener( 'vrdisplaypresentchange', onVRDisplayPresentChange, false );

			onWindowResize();

			initGui();
			animate();

			function initGui() {

				function updateComposer() {

					var passes = composer.passes;

					passes[ 1 ].enabled = api.Bloom;
					passes[ 2 ].enabled = api.Film;
					passes[ 3 ].enabled = api.Glitch;
					passes[ 4 ].enabled = api.FXAA;

					var found = false;

					for ( var i = passes.length - 1; i > 0; i -- ) {

						var pass = passes[ i ];

						if ( ! found && pass.enabled ) {

							pass.renderToScreen = true;
							found = true;

						} else {

							pass.renderToScreen = false;

						}

					}

					passes[ 0 ].renderToScreen = ! found;

				}

				var api = {
					'Bloom': true,
					'Film': true,
					'Glitch': true,
					'FXAA': true
				};

				var gui = new dat.GUI();

				gui.add( api, 'Bloom' ).onChange( function () {

					updateComposer();

				} );

				gui.add( api, 'Film' ).onChange( function () {

					updateComposer();

				} );

				gui.add( api, 'Glitch' ).onChange( function () {

					updateComposer();

				} );

				gui.add( api, 'FXAA' ).onChange( function () {

					updateComposer();

				} );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
				composer.setSize( window.innerWidth, window.innerHeight );

			}

			function onVRDisplayPresentChange() {

				if ( renderer.vr.getDevice() && renderer.vr.getDevice().isPresenting ) {

					stats.dom.style.display = 'none';
					document.getElementsByClassName('dg ac')[ 0 ].style.display = 'none';

				} else {

					stats.dom.style.display = '';
					document.getElementsByClassName('dg ac')[ 0 ].style.display = '';

				}

			}

			function animate() {

				requestAnimationFrame( animate );

				stats.begin();

				group.rotation.x += 0.005;
				group.rotation.y += 0.01;

				composer.render();

				stats.end();

			}

		</script>

	</body>
</html>
